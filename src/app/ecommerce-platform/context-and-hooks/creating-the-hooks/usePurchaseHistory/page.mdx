import BackToTop from "@/components/BackToTop";

# usePurchaseHistory

## Table of Contents

## Introduction

The `usePurchaseHistory` hook is designed to manage the user's purchase history within the e-commerce platform. This hook will allow users to view their past orders, including details such as order date, items purchased, and total amount spent. By encapsulating this functionality in a custom hook, we can keep our components clean and focused on rendering UI, while the logic for fetching and managing purchase history is handled separately.

## Implementation

```tsx
// src/hooks/usePurchaseHistory.ts

import {
  getOrderHistory,
  getPreviouslyPurchased,
  getUserPurchaseStats,
} from "@/api/carts";
import { useAuth } from "@/app/context/authContext";
import { CartProduct, Cart } from "@/lib/interfaces/cart";
import { useEffect, useState } from "react";

interface UsePurchaseHistoryReturn {
  previouslyPurchased: CartProduct[];
  orderHistory: Cart[];
  purchaseStats: {
    totalOrders: number;
    totalSpent: number;
    totalItems: number;
    totalSavings: number;
  } | null;
  isLoading: boolean;
  error: string | null;
  refetch: () => void;
}
```

##### Explanation of the Code

```tsx startLineNumber=23
/**
 * Custom hook to fetch and manage user's purchase history
 * Automatically fetches data when user logs in or user ID changes
 */
export function usePurchaseHistory(): UsePurchaseHistoryReturn {
  const { user } = useAuth();
  const [previouslyPurchased, setPreviouslyPurchased] = useState<CartProduct[]>(
    []
  );
  const [orderHistory, setOrderHistory] = useState<Cart[]>([]);
  const [purchaseStats, setPurchaseStats] = useState<{
    totalOrders: number;
    totalSpent: number;
    totalItems: number;
    totalSavings: number;
  } | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchData = async () => {
    if (!user || !user.id) {
      // Clear data if no user
      setPreviouslyPurchased([]);
      setOrderHistory([]);
      setPurchaseStats(null);
      return;
    }

    // Extract numeric user ID (remove "demo-" prefix if present)
    const numericUserId = user.id.startsWith("demo-")
      ? parseInt(user.id.replace("demo-", ""))
      : parseInt(user.id);

    if (isNaN(numericUserId)) {
      setError("Invalid user ID format");
      return;
    }

    setIsLoading(true);
    setError(null);
```

##### Explanation of the Code

```tsx startLineNumber=63
    try {
      // Fetch all data concurrently
      const [purchased, history, stats] = await Promise.all([
        getPreviouslyPurchased(numericUserId),
        getOrderHistory(numericUserId),
        getUserPurchaseStats(numericUserId),
      ]);

      setPreviouslyPurchased(purchased);
      setOrderHistory(history);
      setPurchaseStats(stats);
    } catch (err) {
      console.error("Error fetching purchase history:", err);
      setError("Failed to load purchase history");
      // Set empty data on error
      setPreviouslyPurchased([]);
      setOrderHistory([]);
      setPurchaseStats(null);
    } finally {
      setIsLoading(false);
    }
  };

  // Fetch data when user changes
  useEffect(() => {
    fetchData();
  }, [user?.id]);

  return {
    previouslyPurchased,
    orderHistory,
    purchaseStats,
    isLoading,
    error,
    refetch: fetchData,
  };
}
```

##### Explanation of the Code

##### Benefits of the Hook

## Usage

## Explanation of the Code

## Next Steps

Now that the hooks have been implements, they can be utilized within the application to manage user interactions effectively.

It's time to move onto the components that will become the building blocks of the e-commerce platform. The next step is to implement the [`ProductGrid` component](/ecommerce-platform/components/building-blocks/creating-the-product-grid), which will display a grid of products available for purchase. This component will leverage the hooks we've created to fetch and display product data, enhancing the user experience by providing a visually appealing and functional product browsing interface.

<BackToTop />
